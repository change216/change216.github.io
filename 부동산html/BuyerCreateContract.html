<html>

<head>
  <title>IPFS Image Upload</title>

  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.rawgit.com/ethereum/web3.js/develop/dist/web3.js"></script>
  <script src="https://cdn.rawgit.com/ethereumjs/browser-builds/ddb27f8d/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script>
  <script src="https://unpkg.com/ipfs-api/dist/index.min.js"></script>

  <link rel="stylesheet" href="assets/css/style.min.css">
  <link rel="stylesheet" href="assets/css/modules.css">

  <style>
  </style>

</head>

<body>
 <!-- <section class="MOD_HERO" style="background-image:url(https://unsplash.it/1400/?random)"> -->
   <!--타이틀-->
   <section class="MOD_HERO" style="background-image:url(assets/css/3.png)">
    <div data-layout="_r">
      <div data-layout="de10">
        <h1>계약 관리(구매자)</h1>
        <h3>거래를 진행합니다.</h3>
       
      </div>
    </div>
  </section>

     <!--상태바 메뉴-->
   <section class="MOD_MENU" data-theme="_bgp">
      <div data-layout="_r" class="nopadding">
         <nav class="MOD_MENU_Nav">
            <!-- <p class="MOD_MENU_Title">Menu</p> -->
                        
            <!-- <svg class="MOD_MENU_Button" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">
               <rect width="30" height="6"/>
               <rect y="24" width="30" height="6"/>
               <rect y="12" width="30" height="6"/>
            </svg> -->

            <ul class="AP_Menu_List">
               <li>
                  <a href="#" class="Homebtn" style="background-image: url(assets/css/Home.png);background-repeat: no-repeat; background-size: contain;    background-position: center;" onclick="self.location='http://localhost:2001/부동산html/Main.html';"></a>
               </li>
               <li>
                     <a href="#" data-theme="_bgp">마이페이지 </a>
                     <ul>
                           <li>
                              <a href="#" data-theme="_bgpd"  onclick="self.location='http://localhost:2001/부동산html/UploadDocument.html';">서류 등록</a>
                           </li>
                           <li>
                              <a href="#" data-theme="_bgpd" onclick="self.location='http://localhost:2001/부동산html/MyDocument.html';" >내 서류</a>
                           </li>
                           <li>
                              <a href="#" data-theme="_bgpd"  onclick="self.location='http://localhost:2001/부동산html/UpdateDocument.html';">내 서류 변경</a>
                           </li>
                           <li>
                              <a href="#" data-theme="_bgpd" >내 서류 열람 허가</a>
                           </li>
                     </ul>
               </li>
                
               <li>
                  <a href="#" data-theme="_bgp" >판매자</a>
                  <ul>
                     <li>
                        <a href="#" onclick="self.location='http://localhost:2001/부동산html/Setseller.html';" data-theme="_bgpd">판매자 등록</a>
                     </li>
                     <li>
                        <a href="#" onclick="self.location='http://localhost:2001/부동산html/UploadProduct.html';" data-theme="_bgpd">매물 등록</a>
                     </li>
                     <li>
                        <a href="#" onclick="self.location='http://localhost:2001/부동산html/UpdateProduct.html';" data-theme="_bgpd">매물 변경</a>
                     </li>
                     <li>
                        <a href="#" onclick="self.location='http://localhost:2001/부동산html/SellerCreateContract.html';" data-theme="_bgpd">계약 관리</a>
                     </li>
                     <li>
                        <a href="#" data-theme="_bgpd">내 매물</a>
                     </li>
                  </ul>
               </li>

               <li>
                  <a href="#" data-theme="_bgp">구매자</a>
                  <ul>
                        <li>
                           <a href="#" onclick="self.location='http://localhost:2001/부동산html/Setbuyer.html';" data-theme="_bgpd">구매자 등록</a>
                </li>
                <li>
                           <a href="#" onclick="self.location='http://localhost:2001/부동산html/BuyerCreateContract.html';" data-theme="_bgpd">계약 관리</a>
                        </li>
                     </ul>
               </li>

               <li>
                  <a href="#" data-theme="_bgp">메뉴 4</a>
               </li>
               <li>
                  <a href="#" data-theme="_bgp">메뉴 5</a>
               </li>
               <li>
                  <a href="#" data-theme="_bgp">메뉴 6</a>
                  <ul>
                     <li>
                        <a href="#" data-theme="_bgpd">Sub-Menu Item</a>
                     </li>
                     <li>
                        <a href="#" data-theme="_bgpd">Sub-Menu Item long title</a>
                     </li>
                     <li>
                        <a href="#" data-theme="_bgpd">Sub-Menu Item</a>
                     </li>
                  </ul>
               </li>
            </ul>
         </nav>
      </div>
   </section>

 <!--카테고리분류-->
<section class="MOD_SUBNAVIGATION1">
  <div data-layout="_r">
    <div data-layout="al16 al-o2 de-o1 de6 ec4">
      <nav class="MOD_SUBNAVIGATION1_Menu" data-theme="_bo2">
        <p class="MOD_SUBNAVIGATION1_Menutitle" data-theme="_bgs"></p>
      <ul>
         <li>
            <a href="#">ALL</a>
         </li>
         <li>
            <a  href="#">아파트</a>
         </li>
         <li>
            <a  href="#">빌라</a>
         </li>
         <li>
            <a  href="#">주택</a>
         </li>
         <li>
            <a  href="#">미정</a>
         </li>
         <li>
            <a href="#">미정</a>
         </li>
         <li>
            <a href="#">미정</a>
         </li>
      
      </ul>
      </nav>
    </div>
   <div data-layout="al-o1 de-o2 de10" class="MOD_SUBNAVIGATION1_Page">
         <section>
            <div data-layout="_r" class="MOD_IMPACTSTRIP3">

               <div data-layout="al16 de8" class="MOD_IMPACTSTRIP3_TxtContainer" data-theme="_bgd">

                  <div class="MOD_IMPACTSTRIP3_Txt">
                     <h2 data-theme="_bo3">구매자 계약 관리</h2>

                     <fieldset  style="border: 2px solid black; margin-top: 2rem; width:60rem; position: static;">
                           <legend style="color: black;font-weight: bold">내 구매요청 목록</legend>
                           <div id="board2" style="margin: 1rem"></div>
                  <div id="board" style="margin: 0.5rem"></div>
                     </fieldset>
                     
                  

                     <p>거래 계약주소 :
                        <input type="text" id="transaddr" style="margin-bottom: 8px;"> </p>
                     <p>판매자 ID :
                        <input type="text" id="sellerid" style="margin-bottom: 8px;">
                     </p>
                     <button onMouseover="this.style.color='red';" style="margin: 1rem 0 0 38.8rem; padding: 0.5rem 9rem 0.5rem 9rem; " onMouseout="this.style.color='black';" class="documentbtn" type="button" onclick="pay()">송 금</button>
                     
                     <h2 data-theme="_bo3">계약 상태</h2>
                     <p>검색 매물 인덱스 :
                        <input type="text" id="proindex" style="margin-bottom: 8px;">
              </p>
              <button onMouseover="this.style.color='red';" style="margin: 1rem 0 0 36.3rem; padding: 0.5rem 9rem 0.5rem 9rem; " onMouseout="this.style.color='black';" class="documentbtn" type="button" onclick="checkState()">상태 확인</button>
              <fieldset  style="border: 2px solid black; margin-top: 2rem; width:60rem; position: static;">
                <legend style="color: black;font-weight: bold">계약 진행 상태</legend>
                <div id="board2" style="margin: 1rem"></div>
                <div id="board3" style="margin: 0.5rem"></div>
              
            </fieldset>
                  </div>
               </div>
            </div>

         </section>
</section>

</div>
</div>

</section>
<!-- <section>
        <div data-layout="_r" class="MOD_IMPACTSTRIP3">
                    <div data-layout="al16 de8" class="MOD_IMPACTSTRIP3_TxtContainer" data-theme="_bgd">
                            <div class="MOD_IMPACTSTRIP3_Txt">
                                <p> 나의 구매요청 목록 </p>
                                    <p><table id="table1"/></p> 
        </div>
            <div data-layout="_r" class="MOD_IMPACTSTRIP3">

                <p> 거래 계약주소:  <input type="text" id="transaddr"  style="margin-bottom: 8px;"/> </p>
            <p> 판매자 id:  <input type="text" id="sellerid"  style="margin-bottom: 8px;"/> </p>
            
            <button type="button" onclick="pay()">송금하기</button>
            <p> 매물인덱스:  <input type="text" id="proindex"  style="margin-bottom: 8px;"/><button type="button" onclick="checkState()">상태확인</button>
             계약 상태: <span id="trans_state"/></p>
            </div>
                
           
         </div> </div>
   </section> -->
</body>
   
    <script type="text/javascript">
       	var contractAddress = '0x950aa9402a0122572a086ee93736b8370fe627b7';
  var RealEstateTransactionContract = web3.eth.contract([{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"buyerDetail","outputs":[{"name":"flag","type":"bool"},{"name":"id","type":"string"},{"name":"name","type":"string"},{"name":"Tell","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_index","type":"uint256"}],"name":"favoriteProduct","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"GetMyProduct","outputs":[{"name":"","type":"string"},{"name":"","type":"uint256"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"address"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"productArray","outputs":[{"name":"ProductAddress","type":"string"},{"name":"ProductInfo","type":"string"},{"name":"Price","type":"uint256"},{"name":"Tag","type":"string"},{"name":"ProductName","type":"string"},{"name":"ImageHashsrc","type":"string"},{"name":"owner","type":"address"},{"name":"Productnumber","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"IndexToPrice","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"GetMyProductnumber","outputs":[{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"IndexToContract","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"GetProdctsSize","outputs":[{"name":"count","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getSellerScore","outputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_index","type":"uint256"},{"name":"score","type":"uint256"}],"name":"SellerEvaluation","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"IndexToOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"string"},{"name":"_id","type":"string"},{"name":"_tell","type":"uint256"}],"name":"setBuyer","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_ImageHashsrc","type":"string"},{"name":"_ProductAddress","type":"string"},{"name":"_ProductInfo","type":"string"},{"name":"_Price","type":"uint256"},{"name":"_Tag","type":"string"},{"name":"_ProductName","type":"string"}],"name":"SetUploadProduct","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_applicant","type":"address"},{"name":"_span","type":"uint256"}],"name":"SetAllowMyDocument","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_index","type":"uint256"},{"name":"_addr","type":"address"},{"name":"_price","type":"uint256"}],"name":"SetRoomconAddr","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"product_index","type":"uint256"},{"name":"_ImageHashsrc","type":"string"},{"name":"_ProductAddress","type":"string"},{"name":"_ProductInfo","type":"string"},{"name":"_Price","type":"uint256"},{"name":"_Tag","type":"string"},{"name":"_ProductName","type":"string"}],"name":"SetUpdateProduct","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_index","type":"uint256"},{"name":"myaddress","type":"address"}],"name":"setTransOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_index","type":"uint256"},{"name":"_seller","type":"address"}],"name":"BuyRequestListPush","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"favoriteProductresult","outputs":[{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"string"},{"name":"_id","type":"string"},{"name":"_tell","type":"uint256"}],"name":"setSeller","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"sellerDetail","outputs":[{"name":"flag","type":"bool"},{"name":"Tell","type":"uint256"},{"name":"reliability","type":"uint256"},{"name":"Status_Numberofpeople","type":"uint256"},{"name":"Status_sum","type":"uint256"},{"name":"Status_avg","type":"uint256"},{"name":"id","type":"string"},{"name":"name","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_id","type":"string"}],"name":"getMyAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_DocumentName","type":"string"},{"name":"_DocumentImageHashsrc","type":"string"},{"name":"_DocumentImageInfo","type":"string"}],"name":"SetUploadMyDocument","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"DocumentArray","outputs":[{"name":"DocumentName","type":"string"},{"name":"DocumentImageHashsrc","type":"string"},{"name":"DocumentImageInfo","type":"string"},{"name":"Documentowner","type":"address"},{"name":"Documentnumber","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"GetRoomcontractSize","outputs":[{"name":"count","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_index","type":"uint256"},{"name":"_val","type":"uint256"}],"name":"SetRoomconValue","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_index","type":"uint256"},{"name":"_DocumentName","type":"string"},{"name":"_DocumentImageHashsrc","type":"string"},{"name":"_DocumentImageInfo","type":"string"}],"name":"SetUpdateMyDocument","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"RoomcontractList","outputs":[{"name":"transaddr","type":"address"},{"name":"buyer","type":"address"},{"name":"seller","type":"address"},{"name":"price","type":"uint256"},{"name":"product_index","type":"uint256"},{"name":"timestamp","type":"uint256"},{"name":"statevalue","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getRoomconStateValue","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_person","type":"address"},{"name":"_index","type":"uint256"}],"name":"getBuyerDocument","outputs":[{"name":"_allowReference","type":"bool"},{"name":"_approveBlockNo","type":"uint256"},{"name":"_refLimitBlockNo","type":"uint256"},{"name":"_applicant","type":"address"},{"name":"_DocumentName","type":"string"},{"name":"_DocumentImageHashsrc","type":"string"},{"name":"_DocumentImageInfo","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getDocumentList","outputs":[{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"addr","type":"address"}],"name":"getType","outputs":[{"name":"","type":"int256"}],"payable":false,"stateMutability":"view","type":"function"}]);
var RealEstateTransactionStorage;
        var transContract = web3.eth.contract([{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"members","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"sellingPrice","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"con_owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"Allclose","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"deadline","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_id","type":"string"}],"name":"pay","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[],"name":"close","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"isOpened","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"price","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_new","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_temps","type":"address"},{"name":"_index","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"salesVolum","type":"uint256"},{"indexed":false,"name":"sellingPrice","type":"uint256"},{"indexed":false,"name":"deadline","type":"uint256"},{"indexed":false,"name":"beneficiary","type":"address"}],"name":"EscrowStart","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"ConfirmedPayment","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"oldaddr","type":"address"},{"indexed":false,"name":"newaddr","type":"address"}],"name":"TransferOwnership","type":"event"}]);
        var transaddress;
        var transStorage;
        var myAccount;
        var amount;
        var _id;
		var seller_id;
    
        window.addEventListener('load', function () {
    
        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
        // Use Mist/MetaMask's provider
        window.web3 = new Web3(web3.currentProvider);
        } else {
        console.log('No web3? You should consider trying MetaMask!')
        // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
        window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7001"));
        }
        // Now you can start your app & access web3 freely:
        startApp();
        });
    
        function startApp() {
    
        RealEstateTransactionStorage = RealEstateTransactionContract.at(contractAddress);
        web3.eth.getAccounts(function(e,r){ 
            myAccount= r[0]; 
         })
    
       RealEstateTransactionStorage.GetRoomcontractSize(function(e,r){ 
          let length = r.toNumber(); 
          listPrint(length);
          })
        }

        function listPrint(length) {
			
          
          for (let i = 0; i < length; i++) { 

            RealEstateTransactionStorage.RoomcontractList(i, function (e, r) {
              if (r[1] == myAccount) {

				listPrint2(r[4],r[0],r[2]);
              }
            })
          }
        }

		function listPrint2(_index, _addr, _seller){
			RealEstateTransactionStorage.sellerDetail(_seller,function(e,r){
				//console.log(r[6])
				var table = document.createElement('table');
                var row = table.insertRow();
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
                cell1.innerHTML = "요청 매물 인덱스: " + _index;
                cell2.innerHTML = ", 계약 주소: " + _addr;
				cell3.innerHTML = ", 판매자 id: " + r[6];
				table.style.fontWeight = "bold";

                document.getElementById('board').appendChild(table);
			});
		}


          function checkState() {

let index = document.getElementById('proindex').value;

let listindex;
RealEstateTransactionStorage.IndexToContract(index,function(e,r){

   listindex = r.toNumber();
   console.log(listindex);
   RealEstateTransactionStorage.RoomcontractList(listindex, function(e,r){
   console.log(r[6].c["0"]);
   let val = r[6].c["0"];
   switch(val){
      case 0: document.getElementById('board3').innerHTML = '<span style="color: red; font-weight:bold">구매요청 (계약 생성 전)</span>'; break;
      case 1: document.getElementById('board3').innerHTML = '<span style="color: red; font-weight:bold">입금 대기중..</span>'; break;
      case 2: document.getElementById('board3').innerHTML = '<span style="color: blue; font-weight:bold">입금 완료</span>'; break;
      case 3: document.getElementById('board3').innerHTML = '<span style="color: yellow; font-weight:bold">거래 취소</span>'; break; 
      case 4: document.getElementById('board3').innerHTML = '<span style="color: green; font-weight:bold">거래 완료!!!!★★</span>'; break;
   }
})
});
}
        

        function pay() {

            _id = document.getElementById('sellerid').value;
            transaddress = document.getElementById('transaddr').value;
            transStorage = transContract.at(transaddress);

            transStorage.price(function(e,r){console.log(r.c/10000); amount =  web3.toWei(r.c/10000,"ether"); transpay();})

            

        }
        
        function transpay() {
            transStorage.pay(_id,
            { 
               // from: myAccount,
                //to: contractAddress,
                value: amount
            }, function(e,r){
                if(!e) {console.log("돈송금완료");}
            });
        
        }

        </script>
    

</html>